<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.kh.mapper.UserMapper">

    <select id="findAllUsers" resultType="kr.co.kh.model.vo.UserVO">
        SELECT
        u.USER_ID AS userId,
        u.USERNAME AS username,
        u.EMAIL AS email,
        r.ROLE_NAME AS role,
        u.IS_ACTIVE AS active,
        u.IS_EMAIL_VERIFIED AS emailActive,
        u.CREATED_AT AS createdAt
        FROM USERS u
        JOIN USER_AUTHORITY ua ON u.USER_ID = ua.USER_ID
        JOIN ROLE r ON ua.ROLE_ID = r.ROLE_ID
    </select>


    <update id="updateUserRole">
        UPDATE USER_AUTHORITY
        SET ROLE_ID = (
        SELECT ROLE_ID FROM ROLE WHERE ROLE_NAME = CONCAT('ROLE_', #{role})
        )
        WHERE USER_ID = #{userId}
    </update>

    <update id="toggleUserStatus">
        UPDATE USERS
        SET IS_ACTIVE = CASE WHEN IS_ACTIVE = 1 THEN 0 ELSE 1 END
        WHERE USER_ID = #{userId}
    </update>

</mapper>
