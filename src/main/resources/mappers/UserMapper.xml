<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.kh.mapper.UserMapper">

    <!-- ì‚¬ìš©ìž ëª©ë¡ ì¡°íšŒ (VO ë°˜í™˜) -->
    <select id="findAllUsers" resultType="kr.co.kh.model.vo.UserVO">
        SELECT
        u.USER_ID AS userId,
        u.USERNAME AS username,
        u.EMAIL AS email,
        r.ROLE_NAME AS role,
        u.IS_ACTIVE AS active,
        u.IS_EMAIL_VERIFIED AS emailActive,
        u.CREATED_AT AS createdAt
        FROM USERS u
        JOIN USER_AUTHORITY ua ON u.USER_ID = ua.USER_ID
        JOIN ROLE r ON ua.ROLE_ID = r.ROLE_ID
    </select>

    <!-- ROLE_NAMEì„ ê¸°ì¤€ìœ¼ë¡œ ROLE_ID ì¡°íšŒ -->
    <select id="findRoleIdByName" resultType="long">
        SELECT ROLE_ID FROM ROLE WHERE ROLE_NAME = #{roleName}
    </select>

    <!-- ì‚¬ìš©ìž ID ê¸°ì¤€ í˜„ìž¬ ROLE_ID ì¡°íšŒ -->
    <select id="findCurrentRoleIdByUserId" resultType="long">
        SELECT ROLE_ID FROM USER_AUTHORITY WHERE USER_ID = #{userId}
    </select>

    <!-- ROLE_IDë¥¼ ë³€ê²½ -->
    <update id="updateUserRoleById">
        UPDATE USER_AUTHORITY
        SET ROLE_ID = #{roleId}
        WHERE USER_ID = #{userId}
    </update>

    <!-- í™œì„±í™” ìƒíƒœ í† ê¸€ (1 â†’ 0 / 0 â†’ 1) -->
    <update id="toggleUserStatus">
        UPDATE USERS
        SET IS_ACTIVE = CASE WHEN IS_ACTIVE = 1 THEN 0 ELSE 1 END
        WHERE USER_ID = #{userId}
    </update>

    <insert id="insertUser" parameterType="kr.co.kh.model.User" useGeneratedKeys="true" keyProperty="id" keyColumn="USER_ID">
        INSERT INTO USERS (
        EMAIL,
        USERNAME,
        PASSWORD,
        NAME,
        BIRTH,
        IS_ACTIVE,
        IS_EMAIL_VERIFIED,
        CREATED_AT,
        UPDATED_AT
        ) VALUES (
        #{email},
        #{username},
        #{password},
        #{name},
        TO_DATE(#{birth}, 'YYYY-MM-DD'),
        1,
        1,
        sysdate,
        sysdate
        )
    </insert>

    <!-- âœ… ì‚¬ìš©ìž ì •ë³´ ìˆ˜ì • (ì„œë¹„ìŠ¤ì™€ ë©”ì„œë“œëª… ì¼ì¹˜) -->
    <update id="updateUserProfile" parameterType="UserVO">
        UPDATE USERS
        SET
        EMAIL = #{email},
        PROFILE_IMG = #{profileImg}
        WHERE USER_ID = #{userId}
    </update>


    <!-- âœ… ì‚¬ìš©ìž ë‹¨ê±´ ì¡°íšŒ -->
    <select id="findUserById" resultType="kr.co.kh.model.vo.UserVO">
        SELECT
        USER_ID AS userId,
        USERNAME AS username,
        EMAIL AS email,
        BIRTH AS birth,
        PROFILE_IMG AS profileImg  <!-- ðŸ”¥ ì¶”ê°€í•´ì•¼ ìƒˆë¡œê³ ì¹¨ ì‹œ ì´ë¯¸ì§€ ë°˜ì˜ë¨ -->
        FROM USERS
        WHERE USER_ID = #{userId}
    </select>

    <!-- í˜„ìž¬ ë¹„ë°€ë²ˆí˜¸ ì¡°íšŒìš© -->
    <select id="findPasswordByUsername" parameterType="string" resultType="string">
        SELECT PASSWORD
        FROM USERS
        WHERE USERNAME = #{username}
    </select>

    <!-- ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¡œ ì—…ë°ì´íŠ¸ -->
    <update id="updateUserPassword" parameterType="MemberVO">
        UPDATE USERS
        SET PASSWORD = #{password},
        UPDATED_AT = SYSDATE
        WHERE USERNAME = #{username}
    </update>

    <!-- ë¦¬í”Œë ˆì‰¬ í† í° ë° ë””ë°”ì´ìŠ¤ ì •ë³´ ì‚­ì œ -->
    <select id="userLogout" statementType="CALLABLE" parameterType="map">
        {CALL GAME_LOGOUT(
        #{userId, mode=IN, jdbcType=NUMERIC},
        #{result, mode=OUT, jdbcType=VARCHAR}
        )}
    </select>
</mapper>
